sensor:
  # External sensors from Home Assistant
  - platform: homeassistant
    entity_id: !secret weather_entity
    attribute: temperature
    id: ha_weather_temp
    internal: true
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    filters:
      - lambda: |-
          if (isnan(x)) return 10.0f;  // fallback if no weather data
          return x;

  - platform: homeassistant
    entity_id: !secret indoor_entity
    id: ha_indoor_temp
    internal: true
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    filters:
      - lambda: |-
          if (isnan(x)) return 21.0f;  // fallback if missing
          return x;
  
  # External hardware sensor
  - platform: dallas_temp
    name: "Backup Temperature"
    id: backup_temp
    internal: true
    update_interval: 10s
    entity_category: diagnostic
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    device_class: temperature
    icon: mdi:thermometer-probe

  # Internal temperature sensor used
  - platform: template
    id: adaptive_indoor_temp
    name: "Active Indoor Temperature"
    internal: true
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    update_interval: 5s
    lambda: |-
      if (!id(backup_temp_switch).state && !isnan(id(ha_indoor_temp).state)) {
        ESP_LOGI("otgw", "Using Home Assistant temperature");
        return id(ha_indoor_temp).state;
      }

      if (!isnan(id(backup_temp).state)) {
        ESP_LOGW("otgw", "Using backup temperature");
        return id(backup_temp).state;
      }

      ESP_LOGW("otgw", "Using fixed temperature");
      return 21.0f;


  # Central Heating
  - platform: template
    id: boiler_temp
    name: "Water Temperature"
    device_id: ch
    unit_of_measurement: "°C"
    icon: mdi:waves-arrow-up
    accuracy_decimals: 1
    device_class: temperature
    entity_category: diagnostic

  - platform: template
    id: return_temp
    name: "Return Temperature"
    device_id: ch
    unit_of_measurement: "°C"
    icon: mdi:waves-arrow-left
    accuracy_decimals: 1
    device_class: temperature
    entity_category: diagnostic

  - platform: template
    id: modulation
    name: "Boiler Modulation"
    unit_of_measurement: "%"
    icon: mdi:water-percent
    accuracy_decimals: 0
    device_class: power_factor
    entity_category: diagnostic

  - platform: template
    id: setpoint
    name: "Requested flow temperature"
    device_id: ch
    unit_of_measurement: "°C"
    icon: mdi:hydro-power
    accuracy_decimals: 1
    device_class: temperature
    entity_category: diagnostic

  # Domestic Hot Water
  - platform: template
    id: dhw_flow_rate
    name: "DHW Flow Rate"
    device_id: dhw
    unit_of_measurement: "L/min"
    accuracy_decimals: 2
    entity_category: diagnostic
    device_class: volume_flow_rate
  
  - platform: template
    name: "DHW Current temperature"
    id: dhw_temp
    device_id: dhw
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    entity_category: diagnostic
    device_class: temperature

  # Diagnostics
  - platform: wifi_signal
    name: "Wi-Fi Signal"
    update_interval: 60s
    entity_category: diagnostic
    device_class: signal_strength
