climate:
  # Central Heating
  - platform: thermostat
    name: "Central Heating"
    id: ch_climate
    sensor: adaptive_indoor_temp        # feedback sensor order HA sensor > backup sensor > 21C
    device_id: ch
    visual:
      min_temperature: 5
      max_temperature: 40
      temperature_step: 0.5

    min_heating_off_time: 30s
    min_heating_run_time: 30s
    min_idle_time: 30s

    preset:
      - name: away
        default_target_temperature_low: 10
      - name: eco
        default_target_temperature_low: 15
      - name: home
        default_target_temperature_low: 18
      - name: comfort
        default_target_temperature_low: 20
      - name: boost
        default_target_temperature_low: 20

    default_preset: eco

    heat_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          std::string mode = id(compensation_mode).state.c_str();
          std::string preset = "home";
          if (id(ch_climate).preset.has_value()) {
            preset = to_string(id(ch_climate).preset.value());
          }

          float flow_target = 0.0f;

          if (preset == "boost") {
            // ðŸš€ BOOST MODE: override equitherm target with boost temperature
            flow_target = id(boost_temp).state;
            ESP_LOGI("otgw", "BOOST mode active: forcing flow %.1fÂ°C", flow_target);

          } else if (mode == "Equitherm") {
            // Normal equitherm operation
            flow_target = opentherm::Equitherm::calculate_target_temp();
            ESP_LOGI("otgw", "Equitherm mode active (preset %s)", preset.c_str());

          } else {
            // Let the boiler handle its own curve (no override)
            flow_target = 0.0f;
            ESP_LOGI("otgw", "Boiler internal compensation active (preset %s)", preset.c_str());
            return;
          }

          // Safety clamp
          if (flow_target < 10.0f) flow_target = 10.0f;
          if (flow_target > id(max_boiler_temp_heating).state) flow_target = id(max_boiler_temp_heating).state;

          uint16_t raw = static_cast<uint16_t>(flow_target * 256.0f);
          uint32_t frame = ot->build_request(opentherm::WRITE_DATA, 0x11, raw);
          ot->send_frame(frame);

          ESP_LOGI("otgw", "Heating ON | Preset: %s | Flow target: %.1fÂ°C",
                   preset.c_str(), flow_target);

    idle_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          auto preset_opt = id(ch_climate).preset;
          std::string preset_str = "home";
          if (preset_opt.has_value())
            preset_str = to_string(preset_opt.value());

          // Default: stop boiler completely
          float flow_target = 5.0f;

          // Comfort or Boost â†’ keep pipes slightly warm
          if (preset_str == "comfort" || preset_str == "boost") {
            flow_target = 15.0f;
          }

          uint16_t raw = static_cast<uint16_t>(flow_target * 256.0f);
          uint32_t frame = ot->build_request(opentherm::WRITE_DATA, 0x11, raw);
          ot->send_frame(frame);

          ESP_LOGI("otgw", "Heating OFF | Preset: %s | Flow target: %.1fÂ°C",
                   preset_str.c_str(), flow_target);


  # Domestic Hot Waterclimate:
  - platform: thermostat
    name: "Domestic Hot Water"
    id: dhw_climate
    device_id: dhw
    sensor: dhw_temp
    icon: mdi:water-boiler

    visual:
      min_temperature: 40
      max_temperature: 65
      temperature_step: 1.0

    min_heating_off_time: 30s
    min_heating_run_time: 30s
    min_idle_time: 30s

    preset:
      - name: comfort
        default_target_temperature_low: 60
      - name: eco
        default_target_temperature_low: 60

    default_preset: eco

    heat_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          float t = id(dhw_climate).target_temperature;
          opentherm::DHW::set_target_temp(ot, t);
          opentherm::DHW::set_enabled(ot, true);
          ESP_LOGI("dhw_climate", "Heating DHW to %.1fÂ°C", t);

    idle_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          auto preset = id(dhw_climate).preset.value_or(esphome::climate::CLIMATE_PRESET_COMFORT);

          if (preset == esphome::climate::CLIMATE_PRESET_ECO) {
            opentherm::DHW::set_mode(ot, opentherm::DHW::Mode::ECO);
          } else {
            opentherm::DHW::set_mode(ot, opentherm::DHW::Mode::HEAT);
          }

          const char *preset_str =
            (preset == esphome::climate::CLIMATE_PRESET_ECO) ? "Eco" :
            (preset == esphome::climate::CLIMATE_PRESET_COMFORT) ? "Comfort" :
            "Unknown";

          ESP_LOGI("dhw_climate", "DHW preset changed to %s", preset_str);
