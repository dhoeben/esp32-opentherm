sensor:
  # External sensors from Home Assistant
  - platform: homeassistant
    entity_id: !secret weather_entity
    attribute: temperature
    id: ha_weather_temp
    name: Temperature outdoor HA
    icon: mdi:home-assistant
    internal: true
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    web_server:
      sorting_group_id: sorting_diagnostic
    filters:
      - lambda: |-
          if (isnan(x)) return 10.0f;  // fallback if no weather data
          return x;

  - platform: homeassistant
    entity_id: !secret indoor_entity
    id: ha_indoor_temp
    name: Temperature indoor HA
    icon: mdi:home-assistant
    force_update: true
    internal: true
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    web_server:
      sorting_group_id: sorting_diagnostic
  
  # External hardware sensor
  - platform: bme680_bsec
    i2c_id: i2c_bme680
    id: sensor_bme680
    temperature:
      name: "Onboard temperature"
      id: backup_temp
      icon: mdi:thermometer-probe
      oversampling: 16x
      entity_category: diagnostic
      device_class: temperature
      web_server:
        sorting_group_id: sorting_diagnostic

    pressure:
      name: "Onboard Pressure"
      id: backup_pressure
      icon: mdi:thermometer-high
      device_class: pressure
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_diagnostic

    humidity:
      name: "Onboard Humidity"
      id: backup_humdity
      icon: mdi:water-percent
      device_class: humidity
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_diagnostic

    iaq:
      name: "Onbiard IAQ"
      id: backup_iaq
      icon: mdi:air-filter
      device_class: aqi
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_diagnostic

    co2_equivalent:
      name: "Onboard CO2 Equivalent"
      id: backup_co2
      icon: mdi:molecule-co2
      device_class: carbon_dioxide
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_diagnostic

    breath_voc_equivalent:
      name: "Onboard Breath VOC Equivalent"
      id: backup_voc
      icon: mdi:face-mask
      device_class: volatile_organic_compounds
      entity_category: diagnostic
      web_server:
        sorting_group_id: sorting_diagnostic

    address: 0x76
    update_interval: 10s

  # Internal temperature sensor used
  - platform: template
    id: adaptive_indoor_temp
    name: "Temperature indoor"
    icon: mdi:thermometer-auto
    internal: true
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    update_interval: 5s
    web_server:
      sorting_group_id: sorting_diagnostic
    lambda: |-
      float base_temp;

      // 1. Home Assistant
      if (!id(backup_temp_switch).state && !isnan(id(ha_indoor_temp).state)) {
        ESP_LOGI("sensor", "Using Home Assistant temperature");
        base_temp = id(ha_indoor_temp).state;

        return base_temp + id(indoor_temp_offset).state;
      }

      // 2. Backup sensor 
      if (!isnan(id(backup_temp).state)) {
        ESP_LOGW("sensor", "Using backup temperature");
        base_temp = id(backup_temp).state;

        return base_temp + id(indoor_temp_offset).state;
      }

      // 3. Fall-back 
      ESP_LOGW("sensor", "Using fixed temperature (no offset)");
      return 21.0f;



  # Central Heating
  - platform: template
    id: boiler_temp
    name: "Water Temperature"
    device_id: ch
    unit_of_measurement: "°C"
    icon: mdi:waves-arrow-up
    accuracy_decimals: 1
    device_class: temperature
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_diagnostic

  - platform: template
    id: return_temp
    name: "Return Temperature"
    device_id: ch
    unit_of_measurement: "°C"
    icon: mdi:waves-arrow-left
    accuracy_decimals: 1
    device_class: temperature
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_diagnostic

  - platform: template
    id: modulation
    name: "Boiler Modulation"
    unit_of_measurement: "%"
    icon: mdi:water-percent
    accuracy_decimals: 0
    device_class: power_factor
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_diagnostic

  - platform: template
    id: setpoint
    name: "Requested flow temperature"
    device_id: ch
    unit_of_measurement: "°C"
    icon: mdi:hydro-power
    accuracy_decimals: 1
    device_class: temperature
    entity_category: diagnostic
    web_server:
      sorting_group_id: sorting_diagnostic

  # Domestic Hot Water
  - platform: template
    id: dhw_flow_rate
    name: "DHW Flow Rate"
    device_id: dhw
    unit_of_measurement: "L/min"
    accuracy_decimals: 2
    entity_category: diagnostic
    device_class: volume_flow_rate
    web_server:
      sorting_group_id: sorting_diagnostic
  
  - platform: template
    name: "DHW Current temperature"
    id: dhw_temp
    device_id: dhw
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    entity_category: diagnostic
    device_class: temperature
    web_server:
      sorting_group_id: sorting_diagnostic

  # Diagnostics
  - platform: wifi_signal
    name: "Wi-Fi Signal"
    update_interval: 60s
    entity_category: diagnostic
    device_class: signal_strength
    web_server:
      sorting_group_id: sorting_diagnostic
