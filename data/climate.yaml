climate:
  # Central Heating
  - platform: thermostat
    name: "Central Heating"
    icon: mdi:thermostat
    id: ch_climate
    sensor: adaptive_indoor_temp
    humidity_sensor: ha_indoor_humidity
    device_id: ch
    web_server:
      sorting_group_id: sorting_control

    visual:
      min_temperature: 5
      max_temperature: 40
      temperature_step: 0.5

    min_heating_off_time: 30s
    min_heating_run_time: 30s
    min_idle_time: 30s

    preset:
      - name: away
        default_target_temperature_low: 12
      - name: eco
        default_target_temperature_low: 12
      - name: comfort
        default_target_temperature_low: 12
      - name: boost
        default_target_temperature_low: 12

    default_preset: eco

    target_temperature_change_action:
      - lambda: |-
          float new_temp = id(ch_climate).target_temperature;

          auto preset_opt = id(ch_climate).preset;
          auto preset = preset_opt.value_or(esphome::climate::CLIMATE_PRESET_NONE);

          if (preset != esphome::climate::CLIMATE_PRESET_AWAY) {
            id(climate_last_set_temp) = new_temp;
            id(climate_last_active_temp) = new_temp; 
          }

    preset_change:
      - lambda: |-
          auto preset_opt = id(ch_climate).preset;
          auto preset = preset_opt.value_or(esphome::climate::CLIMATE_PRESET_NONE);

          float set_temp;

          if (preset == esphome::climate::CLIMATE_PRESET_AWAY) {
            set_temp = id(preset_away_temp).state;
          } else {
            set_temp = id(climate_last_active_temp);
          }

          auto call = id(ch_climate).make_call();
          call.set_target_temperature(set_temp);
          call.perform();

    heat_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          std::string mode = id(compensation_mode).current_option();
          std::string preset = "eco";
          if (id(ch_climate).preset.has_value())
            preset = to_string(id(ch_climate).preset.value());

          float flow_target = 0.0f;

          // BOOST → max flow
          if (preset == "boost") {
            flow_target = id(max_boiler_temp_heating).state;
            ESP_LOGI("climate", "BOOST → MAX flow %.1f°C", flow_target);

          // ECO / COMFORT → equitherm
          } else if (mode == "Equitherm") {
            // Nieuwe aanroep: via het equitherm_ object
            flow_target = ot->equitherm_.calculate_target(ot->boiler_.get_limit_temp());
            ESP_LOGI("climate", 
                     "Equitherm (%s) → Flow=%.1f°C",
                     preset.c_str(), flow_target);

          // Boiler curve fallback
          } else {
            ESP_LOGI("climate", "Boiler internal curve active");
            return;
          }

          // Clamp to max allowed flow
          float max_flow = id(max_boiler_temp_heating).state;
          if (flow_target < 10.0f) flow_target = 10.0f;
          if (flow_target > max_flow) flow_target = max_flow;

          uint16_t raw = (uint16_t)(flow_target * 256.0f);

          ot->send_request(opentherm::OT_MSG_WRITE_DATA, 0x11, raw);

          ESP_LOGI("climate",
                   "Heating ON | Preset=%s | Flow=%.1f°C",
                   preset.c_str(), flow_target);

    idle_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          std::string preset = "eco";
          if (id(ch_climate).preset.has_value())
            preset = to_string(id(ch_climate).preset.value());

          // Default idle → cold pipes
          float flow_target = 5.0f;

          // Comfort / Boost warm idle
          if (preset == "comfort" || preset == "boost") {
            flow_target = 15.0f;
          }

          uint16_t raw = (uint16_t)(flow_target * 256.0f);

          // AANGEPAST: Nieuwe send methode
          ot->send_request(opentherm::OT_MSG_WRITE_DATA, 0x11, raw);

          ESP_LOGI("climate",
                   "Heating OFF | Preset=%s | Idle Flow=%.1f°C",
                   preset.c_str(), flow_target);

  # Domestic Hot Water
  - platform: thermostat
    name: "Domestic Hot Water"
    id: dhw_climate
    device_id: dhw
    sensor: dhw_temp
    icon: mdi:water-boiler
    web_server:
      sorting_group_id: sorting_control

    visual:
      min_temperature: 40
      max_temperature: 65
      temperature_step: 1.0

    min_heating_off_time: 30s
    min_heating_run_time: 30s
    min_idle_time: 30s

    preset:
      - name: comfort
        default_target_temperature_low: 60
      - name: eco
        default_target_temperature_low: 60

    default_preset: eco

    heat_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          // AANGEPAST: Via dhw_ object en enum class
          ot->dhw_.set_mode(opentherm::DHWMode::HEAT);
          ESP_LOGI("dhw_climate", "Heating DHW enabled");

    idle_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          auto preset = id(dhw_climate).preset.value_or(esphome::climate::CLIMATE_PRESET_COMFORT);

          if (preset == esphome::climate::CLIMATE_PRESET_ECO) {
            ot->dhw_.set_mode(opentherm::DHWMode::ECO);
          } else {
            ot->dhw_.set_mode(opentherm::DHWMode::HEAT);
          }

          const char *preset_str =
            (preset == esphome::climate::CLIMATE_PRESET_ECO) ? "Eco" :
            (preset == esphome::climate::CLIMATE_PRESET_COMFORT) ? "Comfort" :
            "Unknown";

          ESP_LOGI("dhw_climate", "DHW preset changed to %s", preset_str);