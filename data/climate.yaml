climate:
  # Central Heating
  - platform: thermostat
    name: "Central Heating"
    icon: mdi:thermostat
    id: ch_climate
    sensor: adaptive_indoor_temp
    device_id: ch
    web_server:
      sorting_group_id: sorting_control

    visual:
      min_temperature: 5
      max_temperature: 40
      temperature_step: 0.5

    min_heating_off_time: 30s
    min_heating_run_time: 30s
    min_idle_time: 30s

    preset:
      - name: away
        default_target_temperature_low: 12
      - name: eco
        default_target_temperature_low: 12
      - name: comfort
        default_target_temperature_low: 12
      - name: boost
        default_target_temperature_low: 12

    default_preset: eco

    heat_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          std::string mode = id(compensation_mode).current_option();

          std::string preset = "eco";
          if (id(ch_climate).preset.has_value()) {
            preset = to_string(id(ch_climate).preset.value());
          }

          if (preset == "away") {
            const float away = id(away_temp).state;
            if (!isnan(away)) {
              auto call = id(ch_climate).make_call();
              call.set_target_temperature(away);
              call.perform();
            }
          }

          float flow_target = 0.0f;

          if (preset == "boost") {
            flow_target = id(max_boiler_temp_heating).state;
            ESP_LOGI("climate", "BOOST mode active: forcing MAX flow %.1f°C", flow_target);

          } else if (mode == "Equitherm") {
            flow_target = opentherm::Equitherm::calculate_target_temp();
            ESP_LOGI("climate", "Equitherm mode active (preset %s)", preset.c_str());

          } else {
            ESP_LOGI("climate", "Boiler internal compensation active (preset %s)", preset.c_str());
            return;
          }

          // Safety clamp (flow cannot exceed max_heating_limit)
          if (flow_target < 10.0f)
            flow_target = 10.0f;

          if (flow_target > id(max_boiler_temp_heating).state)
            flow_target = id(max_boiler_temp_heating).state;

          uint16_t raw = static_cast<uint16_t>(flow_target * 256.0f);
          uint32_t frame = ot->build_request(opentherm::WRITE_DATA, 0x11, raw);
          ot->send_frame(frame);

          ESP_LOGI("climate", "Heating ON | Preset: %s | Flow target: %.1f°C",
                   preset.c_str(), flow_target);

    idle_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          std::string preset_str = "eco";
          if (id(ch_climate).preset.has_value())
            preset_str = to_string(id(ch_climate).preset.value());

          // Default: boiler idle (leidingen koud)
          float flow_target = 5.0f;

          // COMFORT & BOOST → leidingen warm houden
          if (preset_str == "comfort" || preset_str == "boost") {
            flow_target = 15.0f;
          }

          uint16_t raw = static_cast<uint16_t>(flow_target * 256.0f);
          uint32_t frame = ot->build_request(opentherm::WRITE_DATA, 0x11, raw);
          ot->send_frame(frame);

          ESP_LOGI("otgw", "Heating OFF | Preset: %s | Flow target: %.1f°C",
                   preset_str.c_str(), flow_target);


  # Domestic Hot Waterclimate:
  - platform: thermostat
    name: "Domestic Hot Water"
    id: dhw_climate
    device_id: dhw
    sensor: dhw_temp
    icon: mdi:water-boiler
    web_server:
      sorting_group_id: sorting_control

    visual:
      min_temperature: 40
      max_temperature: 65
      temperature_step: 1.0

    min_heating_off_time: 30s
    min_heating_run_time: 30s
    min_idle_time: 30s

    preset:
      - name: comfort
        default_target_temperature_low: 60
      - name: eco
        default_target_temperature_low: 60

    default_preset: eco

    heat_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          float t = id(dhw_climate).target_temperature;
          opentherm::DHW::set_target_temp(ot, t);
          opentherm::DHW::set_enabled(ot, true);
          ESP_LOGI("dhw_climate", "Heating DHW to %.1f°C", t);

    idle_action:
      - lambda: |-
          auto ot = opentherm::OpenThermComponent::get_singleton();
          if (ot == nullptr) return;

          auto preset = id(dhw_climate).preset.value_or(esphome::climate::CLIMATE_PRESET_COMFORT);

          if (preset == esphome::climate::CLIMATE_PRESET_ECO) {
            opentherm::DHW::set_mode(ot, opentherm::DHW::Mode::ECO);
          } else {
            opentherm::DHW::set_mode(ot, opentherm::DHW::Mode::HEAT);
          }

          const char *preset_str =
            (preset == esphome::climate::CLIMATE_PRESET_ECO) ? "Eco" :
            (preset == esphome::climate::CLIMATE_PRESET_COMFORT) ? "Comfort" :
            "Unknown";

          ESP_LOGI("dhw_climate", "DHW preset changed to %s", preset_str);
